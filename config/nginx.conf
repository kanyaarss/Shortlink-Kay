# Nginx Configuration for Shortlink Kay v1
# File: /etc/nginx/sites-available/kanyaars.cloud
# Deploy: sudo ln -s /etc/nginx/sites-available/kanyaars.cloud /etc/nginx/sites-enabled/

# HTTP to HTTPS Redirect
server {
    listen 80;
    listen [::]:80;
    server_name kanyaars.cloud www.kanyaars.cloud;
    
    # Redirect all HTTP to HTTPS
    return 301 https://$server_name$request_uri;
}

# HTTPS Server Block
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name kanyaars.cloud www.kanyaars.cloud;
    
    # ============================================
    # SSL CERTIFICATE (Let's Encrypt)
    # ============================================
    ssl_certificate /etc/letsencrypt/live/kanyaars.cloud/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/kanyaars.cloud/privkey.pem;
    
    # SSL Configuration
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;
    
    # ============================================
    # SECURITY HEADERS
    # ============================================
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-Frame-Options "DENY" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    add_header Permissions-Policy "geolocation=(), microphone=(), camera=()" always;
    
    # ============================================
    # DOCUMENT ROOT & INDEX
    # ============================================
    root /home/shortlink/public;
    index index.php;
    
    # ============================================
    # LOGGING
    # ============================================
    access_log /var/log/nginx/kanyaars.cloud_access.log combined buffer=32k flush=5s;
    error_log /var/log/nginx/kanyaars.cloud_error.log warn;
    
    # ============================================
    # GZIP COMPRESSION
    # ============================================
    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_types text/plain text/css text/xml text/javascript application/json application/javascript application/xml+rss application/rss+xml font/truetype font/opentype application/vnd.ms-fontobject image/svg+xml;
    gzip_min_length 1000;
    gzip_disable "msie6";
    
    # ============================================
    # STATIC FILES CACHING
    # ============================================
    location ~* \.(jpg|jpeg|png|gif|ico|css|js|svg|woff|woff2|ttf|eot|otf)$ {
        expires 30d;
        add_header Cache-Control "public, immutable";
        access_log off;
    }
    
    # ============================================
    # DENY ACCESS TO SENSITIVE FILES
    # ============================================
    location ~ /\. {
        deny all;
        access_log off;
        log_not_found off;
    }
    
    location ~ /config\.php$ {
        deny all;
    }
    
    location ~ /database\.sql$ {
        deny all;
    }
    
    location ~ /\.env$ {
        deny all;
    }
    
    location ~ /\.git/ {
        deny all;
    }
    
    location ~ /storage/ {
        deny all;
    }
    
    location ~ /core/ {
        deny all;
    }
    
    location ~ /app/ {
        deny all;
    }
    
    # ============================================
    # PHP-FPM CONFIGURATION
    # ============================================
    location ~ \.php$ {
        include snippets/fastcgi-php.conf;
        fastcgi_pass unix:/run/php/php8.3-fpm.sock;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        fastcgi_param APP_ENV production;
        fastcgi_intercept_errors on;
        
        # FastCGI Caching (optional)
        fastcgi_cache_bypass $skip_cache;
        fastcgi_no_cache $skip_cache;
    }
    
    # ============================================
    # REDIRECT HANDLER (Shortlink Router)
    # ============================================
    location / {
        # Try file, directory, or pass to router.php
        try_files $uri $uri/ /router.php?code=$uri;
    }
    
    # ============================================
    # API ENDPOINTS
    # ============================================
    location /api/ {
        try_files $uri $uri/ /api.php?$query_string;
    }
    
    # ============================================
    # ADMIN PANEL
    # ============================================
    location /admin/ {
        try_files $uri $uri/ /admin/index.php?$query_string;
    }
    
    # ============================================
    # RATE LIMITING (Optional)
    # ============================================
    # Uncomment untuk enable rate limiting
    # limit_req_zone $binary_remote_addr zone=api_limit:10m rate=10r/m;
    # limit_req_zone $binary_remote_addr zone=shortener_limit:10m rate=20r/m;
    
    # location /api/create {
    #     limit_req zone=api_limit burst=5 nodelay;
    #     try_files $uri $uri/ /api.php?$query_string;
    # }
    
    # location / {
    #     limit_req zone=shortener_limit burst=10 nodelay;
    #     try_files $uri $uri/ /router.php?code=$uri;
    # }
}

# ============================================
# FASTCGI CACHE CONFIGURATION (Optional)
# ============================================
# Uncomment untuk enable caching
# fastcgi_cache_path /var/run/nginx-cache levels=1:2 keys_zone=SHORTLINK:10m max_size=1g inactive=60m use_temp_path=off;
# map $request_method $skip_cache {
#     default 1;
#     GET 0;
# }
